name: Emergency Package Publishing

# Manual execution only - no automatic triggers
"on":
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for emergency publishing'
        required: true
        type: string

# Restrict permissions to contents and packages
permissions:
  contents: read
  packages: write

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: 1

jobs:
  # Access control - restrict to repository owner only
  access-control:
    name: Access Control Check
    runs-on: ubuntu-latest
    steps:
    - name: Check if user is repository owner
      if: github.actor != 'schivei'
      run: |
        echo "❌ Access denied. Only the repository owner (schivei) can execute emergency publishing."
        echo "Current user: ${{ github.actor }}"
        exit 1
    
    - name: Log emergency publish initiation
      run: |
        echo "✅ Emergency publishing initiated by repository owner: ${{ github.actor }}"
        echo "Reason: ${{ github.event.inputs.reason }}"

  emergency-publish:
    name: Emergency Build and Publish
    runs-on: ubuntu-latest
    needs: access-control
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0
        
    - name: Setup .NET SDK 10.x
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: '10.x'
        
    - name: Cache NuGet packages
      uses: actions/cache@v5
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/*.props') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
          
    - name: Restore dependencies
      run: dotnet restore src/NetMediate/NetMediate.csproj
      
    - name: Build Release
      run: dotnet build src/NetMediate/NetMediate.csproj --no-restore --configuration Release
      
    - name: Run Tests
      run: dotnet test tests/NetMediate.Tests/NetMediate.Tests.csproj --no-build --configuration Release --verbosity normal
      
    - name: Pack NuGet package
      run: dotnet pack src/NetMediate/NetMediate.csproj --no-build --configuration Release --output ./packages
      
    - name: List package contents
      run: ls -la ./packages/
      
    - name: Upload package artifacts
      uses: actions/upload-artifact@v6
      with:
        name: emergency-nuget-packages
        path: ./packages/*.nupkg
        retention-days: 90
        
    - name: Publish to NuGet.org
      run: dotnet nuget push ./packages/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate
      env:
        NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
        
    - name: Publish to GitHub Packages
      run: dotnet nuget push ./packages/*.nupkg --api-key ${{ secrets.GITHUB_TOKEN }} --source https://nuget.pkg.github.com/schivei/index.json --skip-duplicate
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Log emergency publish completion
      run: |
        echo "✅ Emergency publishing completed successfully!"
        echo "Reason: ${{ github.event.inputs.reason }}"
        echo "Published by: ${{ github.actor }}"
        echo "Timestamp: $(date -u)"